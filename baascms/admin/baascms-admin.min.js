/**
 * Admin Panel BaasCMS
 * Copyright (c) 2014 Artod gartod@gmail.com
*/
(function(e,t,n,r,i,s){"use strict";if(!i.inited){console.info("Need to initialize BaasCMS first.");return}var o=new i.widgets.Categories({elementSelector:"#categories",onRoute:function(e){this.$el.find("li").removeClass("active");r("#category-"+e.params["cid"]).addClass("active")},afterRender:function(){r('a[data-marker="delete"]',this.$el).on("click",function(e){if(i.adapter.busy)return false;var t=r(this);if(!confirm("All associated articles will be removed also. Are you sure?")){return false}var s=t.data("id"),o=[],u=[];r.when(i.adapter.all("Category",{cache:"no",select:["id","name","parent_id"]}),i.adapter.all("Pattern",{cache:"no",select:["name"]})).then(function(e,t){var a=[],f=0,l=function(t,r){n.each(t,function(t){a.push(t);var i=n.where(e,{parent_id:t.id});if(i.length){l(i,r+1)}})};l(n.where(e,{parent_id:s}),"",f);o=n.pluck(a,"id");o.push(s);u=n.pluck(t,"name");var c=[];n.each(u,function(e){c.push(i.adapter.all(e,{cache:"no",select:["id"],where:{category_id:{$in:o}}}))});return r.when.apply(this,c)}).then(function(){var e=[];n.each(arguments,function(t,r){var s=n.pluck(t,"id");e.push(i.adapter.del(u[r],s))});return r.when.apply(this,e)}).then(function(){return i.adapter.del("Category",o)}).done(function(){l.reload();r("#category-"+s).fadeOut(100,function(){r(this).remove()})});return false})}});var u=function(e,t,r){var i=[["",""]];n.each(t,function(e){i.push([e.name,e.name])});var s=[["",""]],o=function(t,i,u){n.each(t,function(t){if(r===t.id){return}s.push([t.id,n.str.repeat("----",u)+t.name]);var i=n.where(e,{parent_id:t.id});if(i.length){o(i,t.id,u+1)}})};o(n.where(e,{parent_id:""}),"",0);return[{name:"name",type:"text"},{name:"icon",type:"google drive image"},{name:"parent_id",type:"select",options:s},{name:"pattern_name",type:"select",options:i},{name:"template",type:"text"},{name:"place",type:"select",options:["","menu","submenu","catalog","sections","block1","block2","block3"]},{name:"description",type:"textarea"},{name:"article",type:"textarea"}]};var a=function(e,t){var s=r("#add-new-field"),o=r("#pattern-fields");s.on("click",function(){o.append(n.template(r("#template-baascms-pattern-new-field").html(),{data:{},types:i.cons.formFieldTypes}));return false});o.on("click",'a[data-marker="delete-field"]',function(){r(this).closest("div.form-group").fadeOut(100,function(){r(this).remove()});return false});var u='select[data-marker="field-type"]',a='input[data-marker="field-options"]';o.on("change",u,function(){var e=r(this);e.closest("div.row").find(a).parent()[e.val()==="select"?"removeClass":"addClass"]("hidden")});e.on("submit",function(){if(i.adapter.busy)return false;var s=i.utils.collectDataForm(e),f=false;e.find("input").parent().removeClass("has-error");s.name=n.str.classify(s.name.replace(/^[0-9]/,"P$&"));var l=r("#text-name");if(/^[A-Z][a-zA-Z0-9]*$/.test(s.name)){l.val(s.name)}else{l.parent().addClass("has-error");f=true}s.pattern=[];o.find("> div").each(function(e){var t=r(this),i=t.find('input[data-marker="field-name"]'),o=n.str.underscored(i.val().replace(/^[0-9]/,"f$&")),l=t.find(u).val(),c=t.find(a).val();if(/^[a-z][a-z0-9_]*$/i.test(o)){if(n.contains(["id","category_id","acl"],o)){o=o+"_1"}i.val(o)}else{i.parent().addClass("has-error");f=true}s.pattern.push(n.extend({name:o,type:l},l==="select"?{options:c}:{}))});if(f){return false}if(s.id){i.adapter.save("Pattern",s).done(function(e){t(e)})}else{i.adapter.all("Pattern",{cache:"no"}).then(function(e){var t=n.indexBy(e,"name"),r=s.name,o=0;while(t[r]){r=s.name+o;o++}s.name=r;return i.adapter.save("Pattern",s)}).done(function(e){t(e)})}return false})};var f=function(e,t){var i=t?e:{},t=t?t:e,s=n.template(r("#template-baascms-form-element").html()),o="";var u=function(e){var t="form-element-"+n.str.dasherize(e.type)+"-"+n.str.dasherize(e.name),r=i[e.name]?i[e.name]:"";o+=s({id:t,value:r,type:e.type,name:e.name,options:n.isString(e.options)?e.options.split(";"):e.options})};if(i.id){u({name:"id",type:"hidden"})}n.each(t,u);return o};var l=new i.widgets.Main({elementSelector:"#main",itemsOpts:{"*":{afterRender:function(e){var t=e.category.pattern_name,s=e.category.id;if(!t){return}r('a[data-marker="delete"]',this.$el).on("click",function(){if(i.adapter.busy)return false;if(!confirm("Are you sure?")){return false}var e=r(this).data("id");i.adapter.del(t,e).then(function(){return i.adapter.count(t,{cache:"no",where:{category_id:s}})}).then(function(e){if(n.isUndefined(e)){return}return i.adapter.save("Category",{id:s,count:e})}).done(function(){o.load();r("#item"+n.str.dasherize(t)+"-"+e).fadeOut(100,function(){r(this).remove()})});return false})}}},beforeHome:function(){return i.loadHomePage()},routes:{"#/baascms/category/add":function(t){var s=this,a=this.startExpecting();r.when(i.adapter.all("Category",{select:i.cons.categoriesSelect}),i.adapter.all("Pattern")).done(function(t,l){s.fill(a,n.template(r("#template-baascms-form").html(),{header:"Add category",button:"Create",form:f(u(t,l))}));var c=s.$el.find("form");c.on("submit",function(){if(i.adapter.busy)return false;var t=i.utils.collectDataForm(c);i.adapter.save("Category",t).done(function(t){o.load();e.location.hash="/baascms/category/"+t+"/edit"});return false})})},"#/baascms/category/:cid/edit":function(e){var t=this,s=this.startExpecting();r.when(i.adapter.getById("Category",e["cid"],{cache:"no"}),i.adapter.all("Category",{select:i.cons.categoriesSelect}),i.adapter.all("Pattern")).done(function(a,l,c){if(!a.id){t.fill(s,"Category was not found.");return}t.fill(s,n.template(r("#template-baascms-form").html(),{header:"Edit category",button:"Update",form:f(a,u(l,c,e["cid"]))}));var h=t.$el.find("form");h.on("submit",function(){if(i.adapter.busy)return false;var e=i.utils.collectDataForm(h);i.adapter.save("Category",e).done(function(e){i.message("Updated","success");o.load()});return false})})},"#/baascms/category/:cid/item/add":function(t){var s,u=t["cid"],a=this,l=this.startExpecting();i.adapter.getById("Category",u,{cache:"no"}).then(function(e){s=e;if(!s.id){a.fill(l,"Such a category was not found.");return}return i.adapter.first("Pattern",{where:{name:s.pattern_name}})}).done(function(t){if(!t){return}if(!t.name){a.fill(l,"There is no pattern for this category.");return}t.pattern.push({name:"category_id",type:"hidden"});var s=r("#template-baascms"+n.str.dasherize(t.name)+"-form").html()||r("#template-baascms-form").html();a.fill(l,n.template(s,{header:"Add "+n.str.humanize(t.name),button:"Create",form:f({category_id:u},t.pattern)}));var c=a.$el.find("form");c.on("submit",function(){if(i.adapter.busy)return false;var r=i.utils.collectDataForm(c);i.adapter.save(t.name,r).then(function(e){return i.adapter.count(t.name,{where:{category_id:u}})}).then(function(e){if(n.isUndefined(e)){return}return i.adapter.save("Category",{id:u,count:e})}).done(function(){o.load();e.location.hash="/baascms/category/"+u});return false})})},"#/baascms/category/:cid/item/:iid/edit":function(e){var t,s=e["cid"],o=e["iid"],u=this,a=this.startExpecting();i.adapter.all("Category",{select:i.cons.categoriesSelect}).then(function(e){t=n.findWhere(e,{id:s});if(!t||!t.id){u.fill(a,"Such a category was not found.");return}return r.when(i.adapter.all("Pattern"),i.adapter.getById(t.pattern_name,o,{cache:"no"}))}).done(function(e,s){if(!e||!s){return}var o=n.findWhere(e,{name:t.pattern_name});if(!o.name){u.fill(a,"There is no pattern for this category.");return}if(!s.id){u.fill(a,"Item was not found.");return}o.pattern.push({name:"category_id",type:"hidden"});var l=n.str.trim(r("#template-baascms"+n.str.dasherize(o.name)+"-form").html())||r("#template-baascms-form").html();u.fill(a,n.template(l,{header:"Edit "+n.str.humanize(o.name),button:"Update",form:f(s,o.pattern)}));var c=u.$el.find("form");c.on("submit",function(){if(i.adapter.busy)return false;var e=i.utils.collectDataForm(c);i.adapter.save(o.name,e).done(function(){i.message("Updated","success")});return false})})},"#/baascms/patterns":function(e){var t=function(e,t){var n=e.data("id");i.adapter.del("Pattern",n).done(function(){r("#pattern"+"-"+n).fadeOut(100,function(){r(this).remove()})})};var s=this,o=this.startExpecting();i.adapter.all("Pattern",{select:["id","name"],order:"-createdAt"}).done(function(e){s.fill(o,n.template(r("#template-baascms-patterns").html(),{data:e}));r('a[data-marker="delete"]',s.$el).on("click",function(e){if(i.adapter.busy)return false;if(!confirm("Are you sure?")){return false}t(r(this),e);return false})})},"#/baascms/pattern/add":function(t){this.$el.html(n.template(r("#template-baascms-pattern-form").html(),{header:"Add pattern",button:"Create",data:{},types:i.cons.formFieldTypes}));a(this.$el.find("form"),function(t){e.location.hash="/baascms/patterns"})},"#/baascms/pattern/:id/edit":function(e){var t=this,s=this.startExpecting();i.adapter.getById("Pattern",e["id"],{cache:"no"}).done(function(e){t.fill(s,n.template(r("#template-baascms-pattern-form").html(),{header:"Edit pattern",button:"Update",data:e,types:i.cons.formFieldTypes}));a(t.$el.find("form"),function(){i.message("Updated","success")})})}}});r(function(){r(t).on("click",'a[data-marker="google-drive-delete"]',function(){var e=r(this),t=e.parent(),n=t.find("input:hidden"),i=t.find('[data-marker="google-drive-result"]');n.val("");e.hide();i.hide();return false});r(t).on("click",'a[data-marker="gdrive-picker"]',function(){var e=r(this);if(e.data("busy")){return false}e.data("busy",1);var t=e.data("type");var n=new FilePicker({apiKey:"AIzaSyB-eOMMlzO0Wet2KL8r3qbKEhdLw4ORYe0",clientId:"802148819674-63aj228ta4fgssfst74shhcg9n91uvrb",type:t,onPickerApiLoaded:function(){e.data("busy",0)},onSelect:function(n){if(!n.shared){i.message("Do not forget to share this file on Google Drive!","info")}var r=e.parent(),s=r.find("input:hidden"),o=r.find('a[data-marker="google-drive-delete"]'),u=r.find('[data-marker="google-drive-result"]'),a="//drive.google.com/uc?export=view&id="+n.id;s.val(a);o.show();if(t==="img"){u.find("img").attr("src",a)}u.show().attr("href",a)}});n.open();return false})})})(window,document,window._,window.jQuery,window.BaasCMS);(function(){var e=false,t=false;var n=window.FilePicker=function(n){this.apiKey=n.apiKey;this.clientId=n.clientId;this.onSelect=n.onSelect;this.onPickerApiLoaded=n.onPickerApiLoaded;this.type=n.type;if(!e){gapi.client.setApiKey(this.apiKey);gapi.client.load("drive","v2",this._driveApiLoaded.bind(this))}if(!t){google.load("picker","1",{callback:this._pickerApiLoaded.bind(this)})}else{this.onPickerApiLoaded()}};n.prototype={open:function(){var e=gapi.auth.getToken();if(e){this._showPicker()}else{this._doAuth(false,function(){this._showPicker()}.bind(this))}},_showPicker:function(){var e=gapi.auth.getToken().access_token;this.picker=(new google.picker.PickerBuilder).addView(google.picker.ViewId.FOLDERS);if(this.type==="img"){var t=new google.picker.View(google.picker.ViewId.DOCS_IMAGES);t.setMimeTypes("image/png,image/jpeg,image/jpg,image/gif");this.picker.addView(t)}else{this.picker.addView(google.picker.ViewId.DOCS).addView(google.picker.ViewId.DOCS_IMAGES)}this.picker.setAppId(this.clientId).setOAuthToken(e).setCallback(this._pickerCallback.bind(this)).build().setVisible(true)},_pickerCallback:function(e){if(e[google.picker.Response.ACTION]==google.picker.Action.PICKED){var t=e[google.picker.Response.DOCUMENTS][0],n=t[google.picker.Document.ID],r=gapi.client.drive.files.get({fileId:n});r.execute(this._fileGetCallback.bind(this))}},_fileGetCallback:function(e){if(this.onSelect){this.onSelect(e)}},_pickerApiLoaded:function(){t=true;this.onPickerApiLoaded()},_driveApiLoaded:function(){e=true;this._doAuth(true)},_doAuth:function(e,t){gapi.auth.authorize({client_id:this.clientId+".apps.googleusercontent.com",scope:"https://www.googleapis.com/auth/drive.readonly",immediate:e},t)}}})()